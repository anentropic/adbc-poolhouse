---
phase: 07-documentation-and-pypi-publication
plan: "04"
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/release.yml
autonomous: true
requirements:
  - DIST-02
  - DIST-03

must_haves:
  truths:
    - "release.yml pipeline is: build → (validate + changelog in parallel) → publish-testpypi → smoke-test-testpypi → publish-pypi → deploy-docs"
    - "Cookiecutter placeholder bug is fixed (no {{ cookiecutter.package_name }} in workflow)"
    - "Python matrix is ['3.11', '3.12'] not ['3.11', '3.14']"
    - "py.typed presence check remains in validate job"
    - "Version-in-wheel vs git-tag check is in validate job"
    - "TestPyPI publish uses OIDC (pypa/gh-action-pypi-publish) with testpypi environment"
    - "deploy-docs job runs after publish-pypi succeeds and deploys to GitHub Pages"
  artifacts:
    - path: ".github/workflows/release.yml"
      provides: "Complete release pipeline"
      contains: "publish-testpypi"
  key_links:
    - from: "publish-testpypi"
      to: "smoke-test-testpypi"
      via: "needs: [publish-testpypi]"
      pattern: "needs:.*publish-testpypi"
    - from: "smoke-test-testpypi"
      to: "publish-pypi"
      via: "needs: [smoke-test-testpypi]"
      pattern: "needs:.*smoke-test-testpypi"
    - from: "publish-pypi"
      to: "deploy-docs"
      via: "needs: [publish-pypi]"
      pattern: "needs:.*publish-pypi"
---

<objective>
Fix two known bugs in `release.yml` and add three new jobs: `publish-testpypi`, `smoke-test-testpypi`, and `deploy-docs`. Rename existing `publish` job to `publish-pypi`. Add version-in-wheel vs git-tag validation step.

Purpose: DIST-02 and DIST-03 require a release workflow that validates the wheel, generates changelog via git-cliff, publishes to TestPyPI first (with smoke test), then publishes to real PyPI, and deploys docs. The current workflow is missing four of these steps and has two bugs.
Output: Updated `.github/workflows/release.yml` with the complete pipeline.
</objective>

<execution_context>
@/Users/paul/.claude/get-shit-done/workflows/execute-plan.md
@/Users/paul/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-documentation-and-pypi-publication/07-CONTEXT.md
@.planning/phases/07-documentation-and-pypi-publication/07-RESEARCH.md
@.github/workflows/release.yml
@.github/workflows/docs.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix bugs and extend release.yml pipeline (DIST-02, DIST-03)</name>
  <files>.github/workflows/release.yml</files>
  <action>
Read the current `.github/workflows/release.yml` fully. Make the following targeted changes:

**Bug Fix 1 — Cookiecutter placeholder (line 67):**
```yaml
# BEFORE (broken):
test-env-wheel/bin/python -c "import {{ cookiecutter.package_name }}; print('Wheel installation OK')"

# AFTER (fixed):
test-env-wheel/bin/python -c "import adbc_poolhouse; print('Wheel installation OK')"
```

**Bug Fix 2 — Python matrix version:**
```yaml
# BEFORE:
matrix:
  python-version: ["3.11", "3.14"]

# AFTER:
matrix:
  python-version: ["3.11", "3.12"]
```

**Add to validate job — Version-in-wheel vs git-tag check:**
Add this step to the validate job, after the py.typed check:
```yaml
      - name: Check wheel version matches git tag
        run: |
          WHEEL_VERSION=$(unzip -p dist/*.whl "*/METADATA" | grep "^Version:" | cut -d' ' -f2)
          TAG_VERSION=${GITHUB_REF_NAME#v}
          if [ "$WHEEL_VERSION" != "$TAG_VERSION" ]; then
            echo "ERROR: Wheel version ($WHEEL_VERSION) does not match git tag ($TAG_VERSION)"
            exit 1
          fi
          echo "Version check OK: $WHEEL_VERSION"
```

**Rename `publish` job to `publish-pypi`:**
Change `name: Publish to PyPI` job key from `publish:` to `publish-pypi:`. Update its `needs:` to `[smoke-test-testpypi]` (was `[validate, changelog]`).

**Add `publish-testpypi` job** (after `changelog` job):
```yaml
  publish-testpypi:
    name: Publish to TestPyPI
    needs: [validate, changelog]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    environment:
      name: testpypi
      url: https://test.pypi.org/p/adbc-poolhouse
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Download distributions
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/
      - name: Publish to TestPyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/
```

**Add `smoke-test-testpypi` job** (after `publish-testpypi`):
```yaml
  smoke-test-testpypi:
    name: Smoke-test from TestPyPI
    needs: [publish-testpypi]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Set up uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: false
      - name: Install from TestPyPI and smoke-test
        run: |
          uv venv smoke-env
          uv pip install \
            --python smoke-env/bin/python \
            --index-url https://test.pypi.org/simple/ \
            --extra-index-url https://pypi.org/simple/ \
            adbc-poolhouse
          smoke-env/bin/python -c "from adbc_poolhouse import create_pool, DuckDBConfig; print('TestPyPI smoke OK')"
```

Note on import validation: Use `from adbc_poolhouse import create_pool, DuckDBConfig` (not `PoolConfig` — `PoolConfig` does not exist in `__all__`; using it would cause the smoke test to fail on a valid wheel).

**Add `deploy-docs` job** (after `publish-pypi` job):
```yaml
  deploy-docs:
    name: Deploy docs to GitHub Pages
    needs: [publish-pypi]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      pages: write
      id-token: write
    concurrency:
      group: docs-deploy
      cancel-in-progress: true
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Set up uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"
      - name: Sync docs dependencies
        run: uv sync --locked --group docs
      - name: Build docs
        run: uv run mkdocs build --strict
      - name: Upload pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site/
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
```

The `deploy-docs` job uses `permissions` at job level (not workflow level) to grant `pages: write`. The workflow-level `permissions: contents: read` does not grant Pages write (Pitfall 8).

**Final pipeline order verification:**
Confirm `needs:` chains form this DAG:
- `build` → no deps
- `validate` → needs [build]
- `changelog` → needs [build]
- `publish-testpypi` → needs [validate, changelog]
- `smoke-test-testpypi` → needs [publish-testpypi]
- `publish-pypi` → needs [smoke-test-testpypi]
- `deploy-docs` → needs [publish-pypi]

Verify the YAML is syntactically valid after all changes.
  </action>
  <verify>
    <automated>cd /Users/paul/Documents/Dev/Personal/adbc-poolhouse && python3 -c "
import yaml, sys
with open('.github/workflows/release.yml') as f:
    data = yaml.safe_load(f)
jobs = data['jobs']
# Check all required jobs exist
required = ['build', 'validate', 'changelog', 'publish-testpypi', 'smoke-test-testpypi', 'publish-pypi', 'deploy-docs']
for job in required:
    assert job in jobs, f'Missing job: {job}'
    print(f'OK: {job}')
# Check no cookiecutter placeholder
content = open('.github/workflows/release.yml').read()
assert 'cookiecutter' not in content, 'Cookiecutter placeholder found'
print('OK: no cookiecutter placeholder')
# Check python matrix
assert '3.14' not in content, 'Python 3.14 found in matrix'
print('OK: no python 3.14')
# Check import validation
assert 'DuckDBConfig' in content, 'DuckDBConfig not in import validation'
print('OK: DuckDBConfig in import check')
print('All checks passed')
"</automated>
  </verify>
  <done>release.yml has 7 jobs in the correct DAG order; no cookiecutter placeholder; Python matrix is ["3.11", "3.12"]; publish-testpypi uses testpypi environment; smoke test imports DuckDBConfig; deploy-docs has job-level pages:write permission</done>
</task>

</tasks>

<verification>
```bash
cd /Users/paul/Documents/Dev/Personal/adbc-poolhouse

# Structural check
python3 -c "
import yaml
data = yaml.safe_load(open('.github/workflows/release.yml'))
jobs = list(data['jobs'].keys())
print('Jobs:', jobs)
for job, config in data['jobs'].items():
    needs = config.get('needs', [])
    print(f'{job} -> needs: {needs}')
"

# Check no template artifacts remain
grep -c "cookiecutter" .github/workflows/release.yml || echo "OK: no cookiecutter"
grep "python-version" .github/workflows/release.yml
```
</verification>

<success_criteria>
- release.yml parses as valid YAML
- Seven jobs present: build, validate, changelog, publish-testpypi, smoke-test-testpypi, publish-pypi, deploy-docs
- No `{{ cookiecutter.package_name }}` in file
- Python matrix is `["3.11", "3.12"]`
- validate job has: py.typed check + version-in-wheel vs git-tag check + both wheel and sdist install checks with `import adbc_poolhouse` (not the cookiecutter placeholder)
- publish-testpypi needs [validate, changelog], uses testpypi environment, OIDC publisher
- smoke-test-testpypi needs [publish-testpypi], imports `create_pool, DuckDBConfig`
- publish-pypi needs [smoke-test-testpypi]
- deploy-docs needs [publish-pypi], has job-level `pages: write` permission
</success_criteria>

<output>
After completion, create `.planning/phases/07-documentation-and-pypi-publication/07-04-SUMMARY.md`
</output>
