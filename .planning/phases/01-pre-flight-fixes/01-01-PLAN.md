---
phase: 01-pre-flight-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - .pre-commit-config.yaml
  - .secrets.baseline
autonomous: true
requirements:
  - SETUP-01
  - SETUP-05

must_haves:
  truths:
    - "basedpyright uses pythonVersion = \"3.11\" — 3.13+ type syntax is rejected, not silently permitted"
    - "detect-secrets hook is present in .pre-commit-config.yaml at rev v1.5.0 and runs on every commit"
    - ".secrets.baseline exists, reflects the current repo scan, and is excluded from the hook's own scan"
    - "prek run --all-files exits 0 with zero violations on the unchanged codebase"
  artifacts:
    - path: "pyproject.toml"
      provides: "Corrected basedpyright pythonVersion setting"
      contains: "pythonVersion = \"3.11\""
    - path: ".pre-commit-config.yaml"
      provides: "detect-secrets hook entry"
      contains: "detect-secrets"
    - path: ".secrets.baseline"
      provides: "Secret scan baseline for current repo state"
      contains: "\"version\":"
  key_links:
    - from: ".pre-commit-config.yaml"
      to: ".secrets.baseline"
      via: "--baseline arg in hook entry"
      pattern: "--baseline.*\\.secrets\\.baseline"
    - from: ".pre-commit-config.yaml"
      to: ".secrets.baseline"
      via: "exclude pattern preventing baseline self-scan"
      pattern: "exclude:.*secrets.*baseline"
---

<objective>
Fix the two broken toolchain config entries so that no pre-existing errors silently corrupt implementation work in subsequent phases.

Purpose: Phase 1's sole purpose is correctness — a 3.14 pythonVersion permits 3.13+ type syntax that would fail at runtime on Python 3.11, and the absence of secret scanning means Snowflake credentials could be committed in Phase 6 without any gate.
Output: Corrected pyproject.toml, updated .pre-commit-config.yaml with detect-secrets, committed .secrets.baseline, prek green.
</objective>

<execution_context>
@/Users/paul/.claude/get-shit-done/workflows/execute-plan.md
@/Users/paul/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-pre-flight-fixes/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix basedpyright pythonVersion and verify zero type errors</name>
  <files>pyproject.toml</files>
  <action>
In `pyproject.toml`, change the single line in `[tool.basedpyright]`:

  pythonVersion = "3.14"   →   pythonVersion = "3.11"

Leave all other settings unchanged (`typeCheckingMode = "strict"`, `include`, `reportPrivateUsage`).

After editing, run `uv run basedpyright` to confirm 0 errors, 0 warnings, 0 notes. The research confirms the current scaffold (a docstring + `__all__ = []` in `__init__.py` plus one import test) produces zero errors under 3.11 strict mode. If any type errors surface, fix them without adding `# type: ignore` suppressions.
  </action>
  <verify>
    <automated>cd /Users/paul/Documents/Dev/Personal/adbc-poolhouse && uv run basedpyright</automated>
    <manual>Output must show "0 errors, 0 warnings, 0 notes" (or equivalent zero-error summary)</manual>
  </verify>
  <done>pyproject.toml contains `pythonVersion = "3.11"` and basedpyright exits 0 with zero type errors on the current codebase</done>
</task>

<task type="auto">
  <name>Task 2: Add detect-secrets hook and generate baseline</name>
  <files>.pre-commit-config.yaml, .secrets.baseline</files>
  <action>
**Step 1 — Add hook entry to `.pre-commit-config.yaml`.**

Append the following repo block after the existing `blacken-docs` entry:

```yaml
- repo: https://github.com/Yelp/detect-secrets
  rev: v1.5.0
  hooks:
  - id: detect-secrets
    args: ['--baseline', '.secrets.baseline']
    exclude: \.secrets\.baseline
```

The global `exclude: ^\.planning/` at the top of `.pre-commit-config.yaml` already excludes the planning directory — do NOT add a hook-level exclude for `.planning/`. The `exclude: \.secrets\.baseline` line on the hook is mandatory (the baseline JSON contains SHA-256 hashes that trigger `HexHighEntropyString` and `SecretKeyword` detectors — confirmed by live test in RESEARCH.md).

**Step 2 — Generate the baseline.**

Run:
```bash
detect-secrets scan --exclude-files "^\.planning/" > .secrets.baseline
```

Using `--exclude-files "^\.planning/"` produces a cleaner baseline that embeds the exclusion in `filters_used` and avoids false-positive entries from planning files. The research confirmed zero real secrets outside `.planning/`.

**Step 3 — Audit before committing.**

Read `.secrets.baseline` and check the `"results"` key. If `"results"` is non-empty (unexpected — research found zero findings outside `.planning/`), report the findings to the user before proceeding. If `"results"` is empty `{}`, proceed silently.

Note: `detect-secrets` is fetched by prek from the GitHub hook entry on first run. Do NOT add it to `pyproject.toml` dev dependencies.
  </action>
  <verify>
    <automated>cd /Users/paul/Documents/Dev/Personal/adbc-poolhouse && python -c "import json; d=json.load(open('.secrets.baseline')); print('baseline OK, results:', len(d.get('results',{})), 'files')"</automated>
    <manual>Confirm .secrets.baseline is valid JSON and "results" is empty or contains only expected entries</manual>
  </verify>
  <done>`.pre-commit-config.yaml` contains the detect-secrets repo entry at v1.5.0 with `--baseline .secrets.baseline` arg and `exclude: \.secrets\.baseline`; `.secrets.baseline` exists as valid JSON</done>
</task>

<task type="auto">
  <name>Task 3: Run prek gate — zero violations required</name>
  <files></files>
  <action>
Run `prek run --all-files` from the project root. This is the hard gate: the plan is not complete until prek exits 0 with zero violations.

On first run after adding the detect-secrets hook, prek will install the hook environment (download detect-secrets from GitHub and create its virtualenv). This is expected and correct — wait for it to complete.

If prek fails with a hook install error ("failed to create environment" or "hook not found"), run `prek install-hooks` first, then retry `prek run --all-files`.

If prek fails on a specific hook:
- `detect-secrets`: Check that `.secrets.baseline` exists and is valid JSON. Check that the `exclude: \.secrets\.baseline` line is present in the hook entry.
- `basedpyright`: Check that `pythonVersion = "3.11"` is saved in `pyproject.toml`.
- Any other hook: Diagnose and fix the specific failure before proceeding.

Do NOT use `--no-verify` or skip hooks. Zero violations is required.
  </action>
  <verify>
    <automated>cd /Users/paul/Documents/Dev/Personal/adbc-poolhouse && prek run --all-files</automated>
    <manual>All hooks show "Passed" in output — no "Failed" entries</manual>
  </verify>
  <done>prek exits 0 with all hooks passing, including detect-secrets; the full expected hook list passes: trailing-whitespace, end-of-file-fixer, check-json, check-toml, check-yaml, ruff, ruff-format, uv-lock, basedpyright, blacken-docs, detect-secrets</done>
</task>

</tasks>

<verification>
Phase 1 is complete when all three of the following are independently verifiable:

1. `grep 'pythonVersion' pyproject.toml` returns `pythonVersion = "3.11"` (not "3.14")
2. `grep -A4 'detect-secrets' .pre-commit-config.yaml` shows the hook entry at v1.5.0 with `--baseline` arg and `exclude:`
3. `prek run --all-files` exits 0 — detect-secrets hook listed as "Passed"
</verification>

<success_criteria>
- `basedpyright` reports `pythonVersion = "3.11"` in `pyproject.toml` — no 3.13+ type features pass silently
- `detect-secrets` is active in `.pre-commit-config.yaml` and runs on every commit
- `prek` passes with zero violations on the unchanged codebase after both fixes
</success_criteria>

<output>
After completion, create `.planning/phases/01-pre-flight-fixes/01-01-SUMMARY.md` using the summary template.
</output>
