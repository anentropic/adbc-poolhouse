---
phase: 02-dependency-declarations
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - pyproject.toml
  - uv.lock
autonomous: true
requirements: [SETUP-02, SETUP-03, SETUP-04]

must_haves:
  truths:
    - "uv sync --all-extras resolves successfully with no errors"
    - "uv.lock is committed to git (previously untracked)"
    - "uv sync --extra duckdb installs only the duckdb package (not snowflake or other drivers)"
    - "uv sync --extra snowflake installs only adbc-driver-snowflake"
    - "prek run --all-files exits 0 after pyproject.toml changes"
  artifacts:
    - path: "uv.lock"
      provides: "Universal cross-platform lock file covering all optional warehouse driver deps"
      contains: "adbc-driver-snowflake"
    - path: "pyproject.toml"
      provides: "Validated dependency declarations (confirmed resolvable by uv)"
      contains: "pydantic-settings>=2.0.0"
  key_links:
    - from: "uv.lock"
      to: "pyproject.toml [project.optional-dependencies]"
      via: "uv lock resolution covering all extras"
      pattern: "name = \"duckdb\""
---

<objective>
Validate that all declared dependencies resolve correctly with uv, commit the uv.lock file, and verify extras isolation. Run prek to confirm the toolchain gate is still green after pyproject.toml changes.

Purpose: The lock file is the contract that CI enforces via `uv sync --frozen`. Without it committed, CI cannot verify reproducible builds. Extras isolation validation confirms that `pip install adbc-poolhouse[duckdb]` does not accidentally pull in unrelated warehouse drivers.

Output: uv.lock committed to git; prek gate green.
</objective>

<execution_context>
@/Users/paul/.claude/get-shit-done/workflows/execute-plan.md
@/Users/paul/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-dependency-declarations/02-CONTEXT.md
@.planning/phases/02-dependency-declarations/02-RESEARCH.md
@.planning/phases/02-dependency-declarations/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Validate full dependency resolution and verify extras isolation</name>
  <files>uv.lock</files>
  <action>
Run `uv sync --all-extras` from the project root. This validates the full resolution graph (all five extras + dev deps) and regenerates `uv.lock`. The `uv-lock` pre-commit hook will also run `uv lock` during the commit step — this pre-commit validation ensures the lock resolves cleanly before hitting the hook.

```bash
cd /Users/paul/Documents/Dev/Personal/adbc-poolhouse && uv sync --all-extras
```

If `uv sync --all-extras` fails:
- "No solution found" or "Package not found: adbc-driver-duckdb" → the duckdb extra was written incorrectly; fix pyproject.toml to use `duckdb>=0.9.1` not `adbc-driver-duckdb`
- Any other resolution failure → read the error message carefully; do not guess at fixes

After `uv sync --all-extras` succeeds, spot-check individual extras isolation to verify the success criteria from the phase roadmap. Run these in separate temporary venvs to confirm isolation:

**Check that duckdb extra resolves independently:**
```bash
cd /Users/paul/Documents/Dev/Personal/adbc-poolhouse && uv sync --extra duckdb --no-dev 2>&1 | tail -5
```
Expected: resolves successfully, no snowflake/postgresql/flightsql/bigquery packages in output.

**Check that snowflake extra resolves independently:**
```bash
cd /Users/paul/Documents/Dev/Personal/adbc-poolhouse && uv sync --extra snowflake --no-dev 2>&1 | tail -5
```
Expected: resolves successfully, no duckdb/postgresql/flightsql/bigquery packages in output.

After isolation checks pass, uv.lock will exist (or be updated) in the project root. Confirm it is non-empty:
```bash
wc -l /Users/paul/Documents/Dev/Personal/adbc-poolhouse/uv.lock
```
Expected: several hundred lines minimum (covering all extras).
  </action>
  <verify>
    <automated>cd /Users/paul/Documents/Dev/Personal/adbc-poolhouse && uv sync --all-extras && echo "uv sync OK" && wc -l uv.lock</automated>
    <manual>Check output of uv sync --all-extras contains no errors and shows packages being installed/resolved</manual>
  </verify>
  <done>uv sync --all-extras exits 0; uv.lock file exists and is non-empty; individual extra resolution (duckdb, snowflake) succeeds in isolation without pulling in unrelated warehouse drivers.</done>
</task>

<task type="auto">
  <name>Task 2: Commit pyproject.toml, uv.lock, and REQUIREMENTS.md; run prek gate</name>
  <files>pyproject.toml, uv.lock, .planning/REQUIREMENTS.md</files>
  <action>
Stage and commit all three modified/new files. The `uv-lock` pre-commit hook will automatically re-run `uv lock` and stage any changes to `uv.lock` during the commit — this is expected behaviour and not a problem.

Stage the files:
```bash
cd /Users/paul/Documents/Dev/Personal/adbc-poolhouse && git add pyproject.toml uv.lock .planning/REQUIREMENTS.md
```

Commit (the `uv-lock` hook will run automatically and re-stage `uv.lock` if it updates it):
```bash
cd /Users/paul/Documents/Dev/Personal/adbc-poolhouse && git commit -m "feat(02): declare runtime deps, optional extras, and dev deps"
```

Expected pre-commit hook sequence on commit:
- `ruff` — runs on Python files (no new Python files changed, should pass quickly)
- `uv-lock` — re-runs `uv lock` and stages uv.lock (idempotent; no error expected)
- `detect-secrets` — scans staged files (no secrets in pyproject.toml or uv.lock; should pass)
- Other hooks — should all pass as no Python source files changed

If any hook fails:
- `uv-lock` failure → resolution problem; re-run `uv sync --all-extras` to diagnose
- `detect-secrets` failure → a package URL or hash in uv.lock triggered a false positive; update the baseline with `detect-secrets scan --update .secrets.baseline`

After the commit succeeds, run prek to confirm the gate is green:
```bash
cd /Users/paul/Documents/Dev/Personal/adbc-poolhouse && prek run --all-files
```

Expected: all hooks pass, exit 0.

Finally verify uv.lock is now tracked by git:
```bash
cd /Users/paul/Documents/Dev/Personal/adbc-poolhouse && git status uv.lock
```
Expected: no output (file is committed and clean).
  </action>
  <verify>
    <automated>cd /Users/paul/Documents/Dev/Personal/adbc-poolhouse && git log --oneline -3 && git status --short</automated>
    <manual>Confirm uv.lock appears in the most recent commit (git show --stat HEAD | grep uv.lock)</manual>
  </verify>
  <done>Commit succeeds with all pre-commit hooks passing; uv.lock is tracked by git; prek run --all-files exits 0; git status shows a clean working tree.</done>
</task>

</tasks>

<verification>
Final phase-level check:
```bash
cd /Users/paul/Documents/Dev/Personal/adbc-poolhouse && git show --stat HEAD | grep -E "pyproject|uv.lock|REQUIREMENTS" && uv sync --frozen && echo "frozen sync OK"
```
`uv sync --frozen` (no network, strict lock enforcement) must exit 0 — this is the same command CI will use. If it fails, the lock file does not match pyproject.toml.
</verification>

<success_criteria>
- `uv sync --all-extras` exits 0 with no resolution errors
- `uv sync --frozen` exits 0 (CI-equivalent check)
- uv.lock is committed to git (was previously untracked)
- All pre-commit hooks pass on the commit containing pyproject.toml + uv.lock changes
- `prek run --all-files` exits 0
- git status shows clean working tree
</success_criteria>

<output>
After completion, create `.planning/phases/02-dependency-declarations/02-02-SUMMARY.md`
</output>
