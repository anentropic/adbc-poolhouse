---
phase: 02-dependency-declarations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - .planning/REQUIREMENTS.md
autonomous: true
requirements: [SETUP-02, SETUP-03, SETUP-04]

must_haves:
  truths:
    - "pyproject.toml has three runtime deps declared with open lower bounds (pydantic-settings>=2.0.0, sqlalchemy>=2.0.0, adbc-driver-manager>=1.0.0)"
    - "pyproject.toml has five optional extras in [project.optional-dependencies]: duckdb, snowflake, postgresql, flightsql, bigquery — plus an [all] meta-extra using self-references"
    - "pyproject.toml [dependency-groups] dev includes syrupy>=4.0 and coverage[toml]"
    - "REQUIREMENTS.md SETUP-02 text reflects open-lower-bound constraint style (not >=X,<Y)"
    - "REQUIREMENTS.md SETUP-03 text reflects PyPI-only extras with Foundry backends explicitly deferred"
  artifacts:
    - path: "pyproject.toml"
      provides: "Runtime deps, optional extras, and dev dep additions"
      contains: "pydantic-settings>=2.0.0"
    - path: ".planning/REQUIREMENTS.md"
      provides: "Corrected requirement descriptions for SETUP-02 and SETUP-03"
      contains: "Open lower bounds only"
  key_links:
    - from: "pyproject.toml [project.optional-dependencies] all"
      to: "pyproject.toml [project.optional-dependencies] duckdb/snowflake/postgresql/flightsql/bigquery"
      via: "self-referencing adbc-poolhouse[extra] pattern"
      pattern: "adbc-poolhouse\\[duckdb\\]"
---

<objective>
Declare all runtime dependencies, optional warehouse extras, and missing dev dependencies in pyproject.toml. Update REQUIREMENTS.md to reflect the actual constraint style and extras scope agreed in CONTEXT.md.

Purpose: Phase 3 onwards requires pydantic-settings and sqlalchemy to be declared; Phase 6 requires syrupy. The uv lock file cannot be complete until all deps are declared. REQUIREMENTS.md must accurately reflect what was decided, not the original placeholder spec.

Output: Updated pyproject.toml with full dependency declarations; corrected REQUIREMENTS.md SETUP-02 and SETUP-03 descriptions.
</objective>

<execution_context>
@/Users/paul/.claude/get-shit-done/workflows/execute-plan.md
@/Users/paul/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-dependency-declarations/02-CONTEXT.md
@.planning/phases/02-dependency-declarations/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add runtime deps, optional extras, and dev deps to pyproject.toml</name>
  <files>pyproject.toml</files>
  <action>
Edit pyproject.toml with the following precise changes:

**1. Replace the empty `dependencies = []` line with:**
```toml
dependencies = [
    "pydantic-settings>=2.0.0",
    "sqlalchemy>=2.0.0",
    "adbc-driver-manager>=1.0.0",
]
```

**2. Add a new `[project.optional-dependencies]` section immediately after the closing bracket of `[project]` and before `[build-system]`:**
```toml
[project.optional-dependencies]
duckdb = ["duckdb>=0.9.1"]
snowflake = ["adbc-driver-snowflake>=1.0.0"]
postgresql = ["adbc-driver-postgresql>=1.0.0"]
flightsql = ["adbc-driver-flightsql>=1.0.0"]
bigquery = ["adbc-driver-bigquery>=1.3.0"]
all = [
    "adbc-poolhouse[duckdb]",
    "adbc-poolhouse[snowflake]",
    "adbc-poolhouse[postgresql]",
    "adbc-poolhouse[flightsql]",
    "adbc-poolhouse[bigquery]",
]
```

**3. In `[dependency-groups] dev`, add two entries to the existing list:**
```toml
"coverage[toml]",
"syrupy>=4.0",
```
Insert them in alphabetical order within the existing dev list (after `basedpyright`, before `ipython`).

**Critical notes:**
- Use `duckdb>=0.9.1` NOT `adbc-driver-duckdb` — `adbc-driver-duckdb` does not exist on PyPI; `adbc_driver_duckdb` is bundled inside the `duckdb` wheel since 0.9.1
- Use open lower bounds only (`>=X`, no upper bound cap `<Y`) for ALL dependencies — locked decision from CONTEXT.md
- The `[all]` extra MUST use self-referencing syntax (`adbc-poolhouse[duckdb]`) not raw package names — this is the standard pip/uv pattern for meta-extras
- `"coverage[toml]"` must be a quoted string in TOML (the brackets are PEP 508 extras syntax, not TOML table syntax)
- Do NOT use `>=X,<Y` ranges anywhere — the original SETUP-02 spec used upper bounds but CONTEXT.md locked decision overrides this
  </action>
  <verify>
    <automated>cd /Users/paul/Documents/Dev/Personal/adbc-poolhouse && python -c "import tomllib; data = tomllib.load(open('pyproject.toml','rb')); deps = data['project']['dependencies']; extras = data['project']['optional-dependencies']; dev = data['dependency-groups']['dev']; assert 'pydantic-settings>=2.0.0' in deps; assert 'sqlalchemy>=2.0.0' in deps; assert 'adbc-driver-manager>=1.0.0' in deps; assert 'duckdb>=0.9.1' in extras.get('duckdb', []); assert any('adbc-poolhouse[duckdb]' in x for x in extras.get('all', [])); assert any('syrupy>=4.0' in x for x in dev); assert any('coverage[toml]' in x for x in dev); print('pyproject.toml structure valid')"</automated>
    <manual>Confirm no `>=X,<Y` upper-bound ranges appear anywhere in the new dep entries</manual>
  </verify>
  <done>pyproject.toml has runtime deps, five optional extras (duckdb/snowflake/postgresql/flightsql/bigquery), an [all] meta-extra using self-references, and syrupy>=4.0 + coverage[toml] in the dev group. Python tomllib parse confirms structure is valid TOML.</done>
</task>

<task type="auto">
  <name>Task 2: Update REQUIREMENTS.md SETUP-02 and SETUP-03 descriptions</name>
  <files>.planning/REQUIREMENTS.md</files>
  <action>
Update two requirement descriptions in `.planning/REQUIREMENTS.md` to reflect the actual implementation decisions from CONTEXT.md. These must be changed before committing so the requirements file accurately documents what was built.

**Replace SETUP-02 line** (currently):
```
- [ ] **SETUP-02**: Add runtime dependencies to `pyproject.toml`: `pydantic-settings>=2.7,<3`, `sqlalchemy>=2.0,<3`, `adbc-driver-manager>=1.0,<2`
```
**With:**
```
- [ ] **SETUP-02**: Add runtime dependencies to `pyproject.toml`: `pydantic-settings>=2.0.0`, `sqlalchemy>=2.0.0`, `adbc-driver-manager>=1.0.0` (open lower bounds only — no upper bound caps; tight `<Y` bounds cause unnecessary consumer dep conflicts for common transitive deps)
```

**Replace SETUP-03 line** (currently):
```
- [ ] **SETUP-03**: Add per-warehouse optional extras: `[duckdb]`, `[snowflake]`, `[bigquery]`, `[postgresql]`, `[flightsql]`, `[databricks]`, `[redshift]`, `[trino]`, `[mssql]`, `[teradata]`, `[all]`
```
**With:**
```
- [ ] **SETUP-03**: Add per-warehouse optional extras for PyPI-available drivers only: `[duckdb]` (via `duckdb>=0.9.1` package — `adbc_driver_duckdb` is bundled inside the `duckdb` wheel since 0.9.1), `[snowflake]`, `[bigquery]`, `[postgresql]`, `[flightsql]`, `[all]`. Foundry-distributed backends (Databricks, Redshift, Trino, MSSQL, Teradata) are NOT given extras in v1 — those drivers are not on PyPI and will be documented in Phase 7.
```

Also update the Traceability table at the bottom of REQUIREMENTS.md — the SETUP-02 and SETUP-03 entries currently read "Pending". Leave them as Pending (they are completed by the end of Phase 2 as a whole, not by this plan alone). No status change needed.

Do not modify any other lines in REQUIREMENTS.md.
  </action>
  <verify>
    <automated>cd /Users/paul/Documents/Dev/Personal/adbc-poolhouse && grep -n "SETUP-02" .planning/REQUIREMENTS.md | head -5 && grep -n "SETUP-03" .planning/REQUIREMENTS.md | head -5</automated>
    <manual>Confirm SETUP-02 no longer contains ">=2.7,<3" and SETUP-03 no longer lists Databricks/Redshift/Trino/MSSQL/Teradata as extras</manual>
  </verify>
  <done>REQUIREMENTS.md SETUP-02 uses open lower bounds description; SETUP-03 explicitly lists only PyPI extras and notes Foundry backends are deferred to Phase 7.</done>
</task>

</tasks>

<verification>
After both tasks complete, verify the full pyproject.toml structure is valid TOML and contains all expected sections:
```bash
cd /Users/paul/Documents/Dev/Personal/adbc-poolhouse && python -c "import tomllib; d = tomllib.load(open('pyproject.toml','rb')); print('sections:', list(d.keys())); print('optional-deps:', list(d['project'].get('optional-dependencies', {}).keys()))"
```
Expected output includes: optional-deps with duckdb, snowflake, postgresql, flightsql, bigquery, all
</verification>

<success_criteria>
- pyproject.toml parses as valid TOML with no errors
- `dependencies` has three runtime entries with open lower bounds (>=X, no upper cap)
- `[project.optional-dependencies]` has six entries (duckdb, snowflake, postgresql, flightsql, bigquery, all)
- `[all]` uses self-referencing `adbc-poolhouse[extra]` syntax
- `[dependency-groups] dev` includes `syrupy>=4.0` and `coverage[toml]`
- REQUIREMENTS.md SETUP-02 describes open-lower-bound rationale
- REQUIREMENTS.md SETUP-03 lists only PyPI extras and defers Foundry backends to Phase 7
</success_criteria>

<output>
After completion, create `.planning/phases/02-dependency-declarations/02-01-SUMMARY.md`
</output>
