---
phase: 06-snowflake-integration
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - .gitignore
  - tests/integration/__init__.py
  - tests/integration/conftest.py
  - tests/integration/test_snowflake.py
  - CONTRIBUTING.md
autonomous: true
requirements:
  - TEST-03

must_haves:
  truths:
    - "Default `uv run pytest` never attempts a Snowflake connection (snowflake marker excluded via addopts)"
    - "Snapshot files contain no credential residue — serializer captures only Arrow schema + deterministic rows"
    - "prek passes on all committed files including any snapshot .json files"
    - "SnowflakeArrowSnapshotSerializer strips roadmap-specified non-deterministic keys defensively before JSON serialization"
    - "CONTRIBUTING.md documents the exact commands to record and replay Snowflake snapshots"
  artifacts:
    - path: "tests/integration/__init__.py"
      provides: "Makes integration a proper Python package"
    - path: "tests/integration/conftest.py"
      provides: "SnowflakeArrowSnapshotSerializer, snowflake_snapshot fixture, snowflake_pool session-scoped fixture with skip-on-no-creds logic"
      exports: ["SnowflakeArrowSnapshotSerializer", "snowflake_snapshot", "snowflake_pool"]
    - path: "tests/integration/test_snowflake.py"
      provides: "Two @pytest.mark.snowflake tests: connection health + Arrow round-trip snapshot"
      contains: "pytest.mark.snowflake"
    - path: "pyproject.toml"
      provides: "snowflake marker registration + addopts excluding snowflake from default runs"
      contains: "not snowflake"
    - path: "CONTRIBUTING.md"
      provides: "Snapshot recording workflow documentation"
      contains: "How to record Snowflake snapshots"
  key_links:
    - from: "tests/integration/conftest.py"
      to: "adbc_poolhouse"
      via: "from adbc_poolhouse import SnowflakeConfig, create_pool"
      pattern: "from adbc_poolhouse import SnowflakeConfig, create_pool"
    - from: "tests/integration/test_snowflake.py"
      to: "tests/integration/conftest.py"
      via: "snowflake_pool and snowflake_snapshot fixtures"
      pattern: "def test_.*snowflake_pool.*snowflake_snapshot"
    - from: "pyproject.toml"
      to: "pytest marker system"
      via: "addopts = \"-m 'not snowflake'\""
      pattern: "not snowflake"
---

<objective>
Add syrupy snapshot tests for Snowflake: custom serializer that strips non-deterministic Arrow
metadata, conftest fixtures with skip-on-no-credentials logic, two integration tests (connection
health + Arrow round-trip), and CONTRIBUTING.md recording workflow documentation.

Purpose: TEST-03 — Snowflake tests are committed as syrupy snapshots that CI replays without
credentials, recorded locally against real Snowflake.

Output: tests/integration/ package with conftest.py + test_snowflake.py; pyproject.toml marker
config; CONTRIBUTING.md snapshot workflow; .gitignore .env.snowflake entry.
</objective>

<execution_context>
@/Users/paul/.claude/get-shit-done/workflows/execute-plan.md
@/Users/paul/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-snowflake-integration/06-CONTEXT.md
@.planning/phases/06-snowflake-integration/06-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Infrastructure, serializer, and conftest fixtures</name>
  <files>
    pyproject.toml
    .gitignore
    tests/integration/__init__.py
    tests/integration/conftest.py
  </files>
  <action>
**1. Update pyproject.toml `[tool.pytest.ini_options]`**

Add `markers` and `addopts` to the existing pytest ini_options section (currently has only `testpaths` or similar — check before editing). Add exactly:

```toml
[tool.pytest.ini_options]
markers = [
    "snowflake: requires real Snowflake credentials (use pytest --override-ini='addopts=' -m snowflake to run)",
]
addopts = "-m 'not snowflake'"
```

If `[tool.pytest.ini_options]` does not exist, create it. If it already has fields, merge — do NOT overwrite the entire section.

**2. Update .gitignore**

Append to `.gitignore` after the existing `.env` and `.envrc` entries:

```
# Snowflake credentials (never commit)
.env.snowflake
*.env.snowflake
```

**3. Create tests/integration/__init__.py**

Empty file — makes the directory a Python package, enabling conftest.py scoping.

**4. Create tests/integration/conftest.py**

Full implementation per research pattern. Use exactly the code structure from RESEARCH.md
`### Complete conftest.py for tests/integration/` section with these specifics:

- `from __future__ import annotations` at top
- stdlib imports: `json`, `os`, `from pathlib import Path`
- Third-party: `import pyarrow as pa`, `import pytest`, `from dotenv import load_dotenv`, `from syrupy.assertion import SnapshotAssertion`, `from syrupy.extensions.json import JSONSnapshotExtension`
- TYPE_CHECKING block: `from syrupy.types import PropertyFilter, PropertyMatcher, SerializableData, SerializedData`
- Project import: `from adbc_poolhouse import SnowflakeConfig, create_pool`

**`_NON_DETERMINISTIC_META_KEYS` constant (frozenset[bytes]):**
```python
_NON_DETERMINISTIC_META_KEYS: frozenset[bytes] = frozenset([
    b"queryId",
    b"elapsedTime",
    b"elapsed_time",
    b"timestamp",
    b"statementId",
    b"queryTime",
])
```

**`SnowflakeArrowSnapshotSerializer` class:**
- Inherits from `JSONSnapshotExtension`
- `file_extension = "json"` class attribute
- Override `serialize(self, data, *, exclude=None, include=None, matcher=None) -> SerializedData`
- If `not isinstance(data, pa.Table)`: call `super().serialize(data, ...)` and return
- Strip schema-level metadata: `raw_meta: dict[bytes, bytes] = data.schema.metadata or {}`; filter out keys in `_NON_DETERMINISTIC_META_KEYS`
- Build `schema_repr` dict with `"fields"` list (name, type as `str(field.type)`, nullable, metadata dict decoded from bytes) and `"metadata"` dict (cleaned schema-level metadata decoded from bytes)
- Build `result: dict[str, Any] = {"schema": schema_repr, "rows": data.to_pylist()}`
- Return `json.dumps(result, indent=2, ensure_ascii=False) + "\n"`

**`snowflake_snapshot` fixture (function-scoped — do NOT add scope parameter):**
```python
@pytest.fixture
def snowflake_snapshot(snapshot: SnapshotAssertion) -> SnapshotAssertion:
    return snapshot.use_extension(SnowflakeArrowSnapshotSerializer)
```

**`snowflake_pool` fixture (session-scoped):**
```python
@pytest.fixture(scope="session")
def snowflake_pool():
    dotenv_path = Path(__file__).parent.parent.parent / ".env.snowflake"
    if dotenv_path.exists():
        load_dotenv(dotenv_path=dotenv_path, override=False)
    if not os.environ.get("SNOWFLAKE_ACCOUNT"):
        pytest.skip("SNOWFLAKE_ACCOUNT not set — skipping Snowflake integration tests")
    config = SnowflakeConfig()
    pool = create_pool(config)
    yield pool
    pool.dispose()
    pool._adbc_source.close()  # type: ignore[attr-defined]
```

**Type annotation note:** `snowflake_pool` fixture returns `Generator[QueuePool, None, None]` via yield — no explicit return type annotation needed; basedpyright infers from yield. `snowflake_snapshot` returns `SnapshotAssertion` explicitly.

**ruff compliance:**
- `PropertyFilter`, `PropertyMatcher`, `SerializableData`, `SerializedData` are in TYPE_CHECKING block only (used only as type annotations in `serialize()` signature)
- `Optional` from typing used for the `serialize()` signature parameters (matches syrupy's base class signature)
- Module docstring required: `"""Fixtures for Snowflake integration tests (TEST-03)."""`
  </action>
  <verify>
    <automated>cd /Users/paul/Documents/Dev/Personal/adbc-poolhouse && uv run prek --hook ruff 2>&1 | tail -5 && uv run python -c "from tests.integration.conftest import SnowflakeArrowSnapshotSerializer, snowflake_snapshot, snowflake_pool; print('imports ok')" 2>&1</automated>
    <manual>Confirm pyproject.toml has [tool.pytest.ini_options] with markers and addopts. Confirm .gitignore has .env.snowflake entries. Confirm tests/integration/conftest.py exists and prek passes.</manual>
  </verify>
  <done>
    prek passes (ruff + basedpyright) on all modified files. `from tests.integration.conftest import SnowflakeArrowSnapshotSerializer` works. `uv run pytest --collect-only` exits 0 (no collection errors from the new files despite no Snowflake credentials — the skip happens at fixture call time, not collection time).
  </done>
</task>

<task type="auto">
  <name>Task 2: Integration tests and CONTRIBUTING.md</name>
  <files>
    tests/integration/test_snowflake.py
    CONTRIBUTING.md
  </files>
  <action>
**1. Create tests/integration/test_snowflake.py**

```python
"""Snowflake integration tests (TEST-03): snapshot-based, CI-safe."""

from __future__ import annotations

import pytest
from syrupy.assertion import SnapshotAssertion


@pytest.mark.snowflake
class TestSnowflakeIntegration:
    """TEST-03: Snowflake syrupy snapshot tests.

    Run locally: pytest --override-ini="addopts=" -m snowflake
    Record: pytest --override-ini="addopts=" -m snowflake --snapshot-update
    """

    def test_connection_health(self, snowflake_pool) -> None:
        """Pool path works: create_pool() + acquire + SELECT 1 + checkin."""
        conn = snowflake_pool.connect()
        cur = conn.cursor()
        cur.execute("SELECT 1")
        row = cur.fetchone()
        assert row is not None
        assert row[0] == 1
        cur.close()
        conn.close()

    def test_arrow_round_trip(
        self,
        snowflake_pool,
        snowflake_snapshot: SnapshotAssertion,
    ) -> None:
        """Arrow schema + rows match committed snapshot; no credentials in snapshot."""
        conn = snowflake_pool.connect()
        cur = conn.cursor()
        cur.execute("SELECT 1 AS n, 'hello' AS s")
        table = cur.fetch_arrow_table()
        cur.close()
        conn.close()
        assert table == snowflake_snapshot
```

**Type annotation note:** `snowflake_pool` fixture has no explicit type annotation in the test — it's a session-scoped fixture yielding a QueuePool but basedpyright does not need the annotation here since we're only calling `.connect()`. If basedpyright reports `reportUnknownParameterType` on `snowflake_pool`, add type annotation `snowflake_pool: Any` with `from typing import Any`.

**2. Create CONTRIBUTING.md**

New file with at minimum:

```markdown
# Contributing to adbc-poolhouse

## How to Record Snowflake Snapshots

Snowflake integration tests use [syrupy](https://github.com/syrupy-project/syrupy) snapshot testing.
Snapshots are committed to the repository and replayed in CI without credentials.

### Prerequisites

1. A Snowflake account with a warehouse and database you can query.
2. Create `.env.snowflake` in the project root (this file is gitignored — never commit it):

   ```bash
   # .env.snowflake — NEVER commit this file
   SNOWFLAKE_ACCOUNT=myorg-myaccount
   SNOWFLAKE_USER=myuser
   SNOWFLAKE_PASSWORD=mypassword
   SNOWFLAKE_WAREHOUSE=MY_WH
   SNOWFLAKE_DATABASE=MY_DB
   ```

3. Install the Snowflake extra:

   ```bash
   uv sync --extra snowflake
   ```

### Recording Snapshots

```bash
pytest --override-ini="addopts=" -m snowflake --snapshot-update
```

This connects to Snowflake with real credentials, executes the test queries, and writes
snapshot files to `tests/integration/__snapshots__/`.

> **Note:** `addopts` in `pyproject.toml` excludes the `snowflake` marker from default runs.
> The `--override-ini="addopts="` flag clears that exclusion for this invocation.

### Verifying Snapshots

After recording, verify snapshots replay correctly without credentials by checking the
snapshot files contain no account identifiers or credentials:

```bash
# Verify no secrets in snapshots (detect-secrets should already catch this):
uv run detect-secrets scan tests/integration/__snapshots__/

# Verify snapshots match (no credentials in environment):
unset SNOWFLAKE_ACCOUNT && pytest --override-ini="addopts=" -m snowflake
# Expected: tests are skipped (SNOWFLAKE_ACCOUNT not set)
```

### Committing Snapshots

Snapshot files in `tests/integration/__snapshots__/` are committed to the repository.
Before committing, run `uv run prek` to ensure detect-secrets passes on the snapshot content.

### CI Behavior

In CI, `SNOWFLAKE_ACCOUNT` is not set. The `snowflake_pool` fixture detects this and calls
`pytest.skip()`, skipping all Snowflake tests without any connection attempt. Default `uv run pytest`
never runs the `snowflake` marker (excluded via `addopts` in `pyproject.toml`).
```
  </action>
  <verify>
    <automated>cd /Users/paul/Documents/Dev/Personal/adbc-poolhouse && uv run prek --hook ruff 2>&1 | tail -5 && uv run pytest --collect-only -q 2>&1 | tail -10</automated>
    <manual>Confirm test_snowflake.py has @pytest.mark.snowflake on class. Confirm `uv run pytest --collect-only` shows the Snowflake tests are collected but warns about unknown marker (expected until addopts takes effect). Confirm `uv run pytest -q` (default run) does NOT attempt a Snowflake connection.</manual>
  </verify>
  <done>
    prek passes on all 6 modified/created files. `uv run pytest -q` completes without any Snowflake connection attempt (all 86 existing tests pass, 0 Snowflake tests run). CONTRIBUTING.md exists with recording workflow documentation including `--override-ini="addopts="` command.
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. `uv run prek` exits 0 (ruff + basedpyright on all modified files)
2. `uv run pytest -q` exits 0 with all existing tests passing, 0 Snowflake tests attempted
3. `uv run pytest --collect-only -q 2>&1 | grep snowflake` shows the two Snowflake tests are collected
4. `grep -r "SNOWFLAKE_ACCOUNT\|SNOWFLAKE_PASSWORD\|myorg" tests/integration/` returns nothing (no credentials in test files)
5. `.gitignore` contains `.env.snowflake`
</verification>

<success_criteria>
1. `uv run pytest -q` passes (all 86 existing tests green, 0 Snowflake tests run — excluded by addopts)
2. `SnowflakeArrowSnapshotSerializer` serializes Arrow tables to stable JSON stripping `queryId`, `elapsedTime`, `elapsed_time`, `timestamp`, `statementId`, `queryTime` from schema metadata
3. `snowflake_pool` fixture skips when `SNOWFLAKE_ACCOUNT` is absent
4. `snowflake_snapshot` fixture returns `snapshot.use_extension(SnowflakeArrowSnapshotSerializer)`
5. `pytest --override-ini="addopts=" -m snowflake` is the documented command to record/replay Snowflake snapshots
6. `.env.snowflake` is in `.gitignore` (credentials never committed)
7. prek gate passes (ruff, basedpyright, detect-secrets all green)
</success_criteria>

<output>
After completion, create `.planning/phases/06-snowflake-integration/06-01-SUMMARY.md`
</output>
